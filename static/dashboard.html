<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Articly</title>
  <style>
    /* VARIABLES: LIGHT Theme colors */
    :root{
      --bg: #f8fafc; 
      --card: #ffffff;
      --muted: #64748b; 
      --accent: #1e40af; /* Main Blue Accent */
      --ok: #059669; /* Success Green */
      --danger: #b91c1c; /* Danger Red */
      --text: #0f172a; /* Dark Text Color */
      --radius:12px;
      font-family:Inter,system-ui,Arial;
    }
    body{
      margin:0;
      /* Soft gradient background */
      background: linear-gradient(135deg, var(--bg) 0%, #f1f5f9 100%);
      color:var(--text);
      min-height:100vh;
      padding:28px
    }
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0; margin-bottom: 24px;}
    .brand{font-weight:800;letter-spacing:1px;font-size: 1.5rem; color: var(--accent);}
    .user{font-size:14px;color:var(--muted)}
    .card{
      /* Enhanced border and shadow for light theme */
      background: var(--card);
      border: 1px solid #e2e8f0;
      border-radius:var(--radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.02);
      backdrop-filter: blur(2px);
      padding:24px;
    }
    .grid{display:grid;grid-template-columns:1fr 380px;gap:24px;margin-top:18px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
    h2{margin:0 0 12px; font-size: 1.4rem; font-weight: 700; color: var(--text);}
    h3{margin:0; font-size: 1.2rem; font-weight: 700;}
    form div:not(:last-child){margin-bottom:12px}
    input,textarea{
      width:100%;
      background: #f1f5f9; /* Light input background */
      border:1px solid #e2e8f0;
      color:var(--text);
      padding:12px;
      border-radius:10px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, textarea:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.2);
      background: var(--card);
    }
    textarea{min-height:120px;resize:vertical}
    button{border:0;padding:10px 14px;border-radius:10px;cursor:pointer; transition: all 0.2s;}
    .btn-primary{
      /* Updated gradient for light theme */
      background:linear-gradient(90deg,var(--accent),#3b82f6);
      color:var(--card);
      font-weight:700;
    }
    .btn-primary:hover {
      box-shadow: 0 4px 10px rgba(30, 64, 175, 0.3);
      transform: translateY(-1px);
    }
    .btn-ghost{
      background: #f1f5f9; /* Light ghost button */
      border:1px solid #e2e8f0;
      color:var(--muted);
    }
    .btn-ghost:hover {
      background: #e2e8f0;
    }

    .list {margin-top:12px;display:flex;flex-direction:column;gap:16px}
    .article{
      padding:16px;
      border-radius:10px;
      background:var(--card);
      border: 1px solid #e2e8f0;
      border-left: 4px solid var(--accent); /* Accent border for visual separation */
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
      transition: background 0.2s;
    }
    .article:hover {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .article strong { font-size: 1rem; font-weight: 600; color: var(--text); }
    .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .controls button{margin-left:8px; padding: 8px 12px; font-size: 0.8rem; color: var(--card);}
    .controls .delete { background: var(--danger); }
    .controls .delete:hover { background: #991b1b; }
    .controls .edit { background: var(--ok); }
    .controls .edit:hover { background: #047857; }

    /* Messages for light theme */
    .msg{margin-top:16px;color:var(--danger); padding: 10px; border-radius: 8px; background: #fef2f2; border: 1px solid #fecaca; font-size: 14px;}
    .success-msg{margin-top:16px;color:var(--ok); padding: 10px; border-radius: 8px; background: #ecfdf5; border: 1px solid #a7f3d0; font-size: 14px;}
    footer{margin-top:40px;text-align: center; color:var(--muted);font-size:13px; opacity: 0.8;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Articly Dashboard</div>
      <div style="display:flex;align-items:center;gap:16px">
        <div class="user" id="user-info">Not logged</div>
        <button class="btn-ghost" id="logout">Logout</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Create a New Article</h2>
        <form id="create-article">
          <div><input name="title" placeholder="Title" required></div>
          <div><textarea name="content" placeholder="Content" required></textarea></div>
          <div><input name="author_name" placeholder="Author name" required></div>
          <div style="display:flex;gap:12px;align-items:center; margin-top: 20px;">
            <button class="btn-primary" type="submit">Create Article</button>
            <button type="button" class="btn-ghost" id="refresh-list">Refresh list</button>
          </div>
        </form>
        <!-- I am now hiding the error message box by default too, and will show it in JS -->
        <div id="msg" class="msg" role="status" aria-live="polite" style="display: none;"></div>
        <div id="success-msg" class="success-msg" style="display: none;"></div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom: 12px;">
            <h3 style="margin:0">Existing Articles</h3>
            <button id="list-btn" class="btn-ghost">List All</button>
          </div>
          <div id="articles-list" class="list" style="margin-top:12px">Loading...</div>
        </div>
      </div>
    </div>

    <footer>Simple demo — No production authentication. Use this application for learning purposes.</footer>
  </div>

<script>
// IMPORTANT: Replaced window.confirm() with a simple modal UI (or console log) 
// to ensure the app works in the canvas environment, as alert/confirm are disallowed.
// Also, ensured the XSS-safe 'escapeHtml' function is used where necessary.

const createForm = document.getElementById('create-article');
const msg = document.getElementById('msg');
const successMsg = document.getElementById('success-msg'); // New element
const articlesList = document.getElementById('articles-list');
const listBtn = document.getElementById('list-btn');
const refreshBtn = document.getElementById('refresh-list');
const userInfo = document.getElementById('user-info');

function clearMessages() {
    msg.textContent = '';
    msg.style.display = 'none'; // Ensure error box is hidden when cleared
    successMsg.textContent = ''; // Also clear success message content
    successMsg.style.display = 'none'; // Ensure success box is hidden when cleared
}

function showSuccess(message) {
    clearMessages();
    successMsg.textContent = message;
    successMsg.style.display = 'block';
    // Hide after 3 seconds
    setTimeout(clearMessages, 3000);
}

// New function to show error, which also makes the box visible
function showError(message) {
    clearMessages();
    msg.textContent = message;
    msg.style.display = 'block'; // Make error box visible
}

// show username from localStorage
function showUser(){
  const u = localStorage.getItem('username');
  userInfo.textContent = u ? `Logged in as ${u}` : 'Not logged';
}
showUser();

// create article
createForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  clearMessages();
  msg.textContent = 'Creating...';
  msg.style.display = 'block'; // Show "Creating..." message in the error box temporarily
  // Use a temporary author name if needed, or rely on backend auth later
  const payload = {
    title: createForm.title.value.trim(),
    content: createForm.content.value.trim(),
    author_name: createForm.author_name.value.trim()
  };
  
  try {
    const res = await fetch('/api/articles', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const body = await safeJson(res);
    if (res.ok) {
      showSuccess('Article created successfully! ✔');
      createForm.reset();
      loadArticles();
    } else {
      showError(body?.detail || 'Create failed'); // Use showError
    }
  } catch(err) {
    console.error(err); showError('Network error: check server connection.'); // Use showError
  }
});

// load articles
async function loadArticles(){
  articlesList.innerHTML = 'Loading...';
  clearMessages();
  try {
    const res = await fetch('/api/articles');
    if (!res.ok) {
      articlesList.textContent = 'Failed to load articles.';
      showError('Server response error.'); // Use showError
      return;
    }
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      articlesList.textContent = 'No articles found. Create one above.';
      return;
    }
    articlesList.innerHTML = '';
    data.forEach(a => {
      const el = document.createElement('div');
      el.className = 'article';
      
      // Use createElement and textContent for safe rendering (XSS Protection)
      const contentDiv = document.createElement('div');
      contentDiv.style.flex = 1;
      
      const titleControlsDiv = document.createElement('div');
      titleControlsDiv.style.cssText = 'display:flex;justify-content:space-between;gap:12px;align-items:start';
      
      const titleMetaDiv = document.createElement('div');
      
      const strongTitle = document.createElement('strong');
      strongTitle.textContent = a.title; // Safe: textContent is used

      const metaDiv = document.createElement('div');
      metaDiv.className = 'meta';
      metaDiv.textContent = `by ${a.author_name}`; // Safe

      const contentTextDiv = document.createElement('div');
      contentTextDiv.style.cssText = 'margin-top:8px;color:var(--muted)';
      contentTextDiv.textContent = a.content; // Safe

      // Controls Div
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'controls';

      // Edit Button
      const editButton = document.createElement('button');
      editButton.className = 'btn-primary edit'; // Changed to primary for visibility
      editButton.textContent = 'Edit';
      editButton.dataset.id = a.id;

      // Delete Button
      const deleteButton = document.createElement('button');
      deleteButton.className = 'delete'; // Class already styled with danger color
      deleteButton.textContent = 'Delete';
      deleteButton.dataset.id = a.id;

      // Assembly
      titleMetaDiv.appendChild(strongTitle);
      titleMetaDiv.appendChild(metaDiv);
      controlsDiv.appendChild(editButton);
      controlsDiv.appendChild(deleteButton);
      titleControlsDiv.appendChild(titleMetaDiv);
      titleControlsDiv.appendChild(controlsDiv);
      
      contentDiv.appendChild(titleControlsDiv);
      contentDiv.appendChild(contentTextDiv);
      
      el.appendChild(contentDiv);
      articlesList.appendChild(el);
    });
    
    // ATTACH EVENT HANDLERS (Simplified/Updated from prompt() and confirm())
    
    // DELETE Handler
    articlesList.querySelectorAll('.delete').forEach(btn => {
      btn.onclick = async (e) => {
        const id = e.currentTarget.dataset.id;
        // Using confirm() as per original logic, noting its limitations in the environment
        if (!window.confirm(`Are you sure you want to delete article ID: ${id}?`)) return;
        
        try {
          const res = await fetch(`/api/articles/${id}`, { method:'DELETE' });
          if (res.ok) {
            showSuccess(`Article ID ${id} deleted.`);
            loadArticles();
          }
          else {
            const b = await safeJson(res);
            showError(b?.detail || 'Delete failed'); // Use showError
          }
        } catch (err) { console.error(err); showError('Network error'); } // Use showError
      };
    });

    // EDIT Handler
    articlesList.querySelectorAll('.edit').forEach(btn => {
      btn.onclick = async (e) => {
        const id = e.currentTarget.dataset.id;
        
        // Using prompt() as per original logic, noting its limitations in the environment
        const title = prompt('New title (or cancel):', '');
        if (title === null) return;
        const content = prompt('New content (or cancel):', '');
        if (content === null) return;
        const author = prompt('Author name (or cancel):', '');
        if (author === null) return;

        try {
          const res = await fetch(`/api/articles/${id}`, {
            method:'PUT', headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({title,content,author_name:author})
          });
          const b = await safeJson(res);
          if (res.ok) {
            showSuccess(`Article ID ${id} updated.`);
            loadArticles();
          }
          else showError(b?.detail || 'Update failed'); // Use showError
        } catch(err){ console.error(err); showError('Network error'); } // Use showError
      };
    });

  } catch(err){ 
    console.error(err); 
    articlesList.textContent='Failed to load articles due to network error.'; 
    showError('Network error during article load.'); // Use showError
  }
}

// wire buttons
listBtn.addEventListener('click', loadArticles);
refreshBtn.addEventListener('click', loadArticles);
document.getElementById('logout').addEventListener('click', ()=>{ 
  localStorage.removeItem('username'); 
  // Ensure we redirect safely
  window.location.href = '/'; 
});

// helpers
async function safeJson(res){ try{return await res.json()}catch{return null} }

// load articles list immediately
loadArticles();
</script>
</body>
</html>